version: '3.8'

services:
  # --- 1. The Traefik Reverse Proxy/Load Balancer Service ---
  traefik:
    image: traefik:v3.6
    container_name: traefik
    # *** UPDATED PORTS ***
    ports:
      - "11480:80"       # Host port 11480 -> Traefik's web entrypoint (80)
      - "11481:8080"   # Host port 11481 -> Traefik Dashboard (8080)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro 
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false 
      - --entrypoints.web.address=:80 # Traefik listens internally on 80
      - --api.dashboard=true
      - --api.insecure=true
    networks:
      - ollama_network

  # --- 2. The Ollama Replicated Service (3 Replicas) ---
  ollama:
    image: ollama/ollama:latest
    # Note: container_name removed - incompatible with replicas in compose
    
    deploy:
      replicas: 3 
      restart_policy:
        condition: on-failure
    
    environment:
      - OLLAMA_HOST=0.0.0.0            
      - OLLAMA_ACCELERATE_SYSTEM=1     
      
    devices:
      - /dev/dri:/dev/dri 
      
    volumes:
      - ollama_data:/root/.ollama:rw
      
    networks:
      - ollama_network
      
    # Traefik configuration labels (No changes here, as Traefik handles the internal routing)
    labels:
      - "traefik.enable=true"
      
      # --- Hostname Routing Rule ---
      - "traefik.http.routers.ollama-rtr.rule=Host(`ollama.localhost`)"
      - "traefik.http.routers.ollama-rtr.entrypoints=web"
      
      # --- Load Balancer Algorithm: LEAST CONNECTION ---
      - "traefik.http.routers.ollama-rtr.service=ollama-service"
      - "traefik.http.services.ollama-service.loadbalancer.server.port=11434"
      - "traefik.http.services.ollama-service.loadbalancer.algorithm=leastconn" 
      
      # --- Health Check ---
      - "traefik.http.services.ollama-service.loadbalancer.healthcheck.path=/api/tags"
      - "traefik.http.services.ollama-service.loadbalancer.healthcheck.interval=10s"
      
# --- Volumes and Network Definitions ---
volumes:
  ollama_data:

networks:
  ollama_network:
